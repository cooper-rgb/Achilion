name: CI

on:
  pull_request:
  push:
    branches: [ main, master ]

jobs:
  compile:
    name: Quick compile
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore cached Swift Packages
        uses: actions/cache@v4
        with:
          path: |-
            ~/Library/Caches/org.swift.swiftpm
            ~/.build
          key: ${{ runner.os }}-swiftpm-${{ hashFiles('**/Package.resolved') }}

      - name: Build (compile only)
        run: |
          set -o pipefail
          xcodebuild -project Achilion.xcodeproj -scheme Achilion -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' clean build

  lint:
    name: Lint (SwiftLint)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew (if missing) and SwiftLint
        run: |
          set -e
          if ! command -v brew >/dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $GITHUB_ENV || true
            eval "$(/opt/homebrew/bin/brew shellenv)" || true
          fi
          brew install swiftlint || true

      - name: Run SwiftLint
        run: |
          if command -v swiftlint >/dev/null; then
            swiftlint lint --quiet || true
          else
            echo "SwiftLint not available; skipping lint step"
          fi

  build-and-test:
    name: Build and Test (macOS)
    runs-on: macos-latest
    needs: [compile, lint]
    env:
      APP_ENV: Development
      GOOGLE_SERVICE_INFO_PLIST: GoogleService-Info-Dev.plist

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore cached Swift Packages (optional)
        uses: actions/cache@v4
        with:
          path: |-
            ~/Library/Caches/org.swift.swiftpm
            ~/.build
          key: ${{ runner.os }}-swiftpm-${{ hashFiles('**/Package.resolved') }}

      - name: Write GoogleService-Info from secret (if present)
        if: ${{ secrets.GOOGLE_SERVICE_INFO_DEV_BASE64 != '' }}
        run: |
          echo "Writing Config/GoogleService-Info-Dev.plist from secret"
          mkdir -p Config
          echo "${{ secrets.GOOGLE_SERVICE_INFO_DEV_BASE64 }}" | base64 --decode > Config/GoogleService-Info-Dev.plist

      - name: Show Xcode/Simulator version
        run: |
          xcodebuild -version
          xcrun simctl list devices | sed -n '1,120p'

      - name: Install dependencies (SPM)
        run: swift package resolve

      - name: Build (iphonesimulator)
        run: |
          set -o pipefail
          xcodebuild -project Achilion.xcodeproj -scheme Achilion -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' clean build 2>&1 | tee build.log

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild test -project Achilion.xcodeproj -scheme Achilion -destination 'platform=iOS Simulator,name=iPhone 14,OS=latest' 2>&1 | tee test.log

      - name: Upload logs (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            build.log
            test.log
